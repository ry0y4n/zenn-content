---
title: "ãƒ­ãƒ¼ã‚«ãƒ« PC ã‹ã‚‰ Azure é–‰åŸŸç’°å¢ƒã¸æ¥ç¶šã™ã‚‹æ–¹æ³•ã€VPN Gateway å…¥é–€ã€‘"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["azure", "vpn", "network"]
published: true
publication_name: "microsoft"
---

Azure ä¸Šã«æ§‹ç¯‰ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ã€**å®Œå…¨ã«é–‰åŸŸåŒ–**ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒ–ï¼‰ã—ãŸã„ã¨ã„ã†è¦ä»¶ã¯ã‚ˆãã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã™ã€‚

-   Azure Functions ã‚„ App Service ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‹ã‚‰é®æ–­ã—ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—ãŸã„
-   Web ã‚¢ãƒ—ãƒªã‚’ VNet çµ±åˆã—ã€å¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ãŸã„
-   API Management ã‚’å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‘ã‘ã«æ§‹æˆã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§ã¯åˆ©ç”¨ã§ããªã„ã‚ˆã†ã«ã—ãŸã„

ã“ã®ã‚ˆã†ãªã€Œé–‰ã˜ãŸç’°å¢ƒã€ã«ãŠã„ã¦ã‚‚ã€ãƒ­ãƒ¼ã‚«ãƒ« PC ã‹ã‚‰é–‹ç™ºã‚„ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ä¸€æ™‚çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´é¢ã¯å¤šãã‚ã‚Šã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€**Azure VPN Gateway ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ« PC ã‚’ Azure ã®ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã™ã‚‹æ‰‹é †**ã‚’ä¸å¯§ã«è§£èª¬ã—ã¾ã™ã€‚åŠ ãˆã¦ã€**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ DNS åã®åå‰è§£æ±º**ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã¾ã§ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

å›³ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’äº¤ãˆã¦è§£èª¬ã—ã¾ã™ã®ã§ã€åˆã‚ã¦ VPN Gateway ã‚’æ‰±ã†æ–¹ã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„å†…å®¹ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

# VPN Gateway ã®ä½œæˆ

é–‰åŸŸåŒ–ã•ã‚ŒãŸ Azure ãƒªã‚½ãƒ¼ã‚¹ ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ« PC ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã€VPN Gateway ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

ä»¥ä¸‹ã®æ§‹æˆã§ VPN Gateway ã‚’ä½œæˆã—ã¾ã™ã€‚VPN Gateway ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯éå¸¸ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€ãŠé¢¨å‘‚ã«å…¥ã£ã¦ã„ã‚‹é–“ã«ä½œæˆã—ã¦ãŠãã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

![alt text](/images/private-apim/create-vpngw-1.png)

> ä½œæˆæ™‚ã¯ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã‚µãƒ–ãƒãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã‚’æŒ‡å®šã—ã¾ã™ã€‚ãã†ã™ã‚‹ã¨ã€VPN Gateway ç”¨ã®ã‚µãƒ–ãƒãƒƒãƒˆãŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ã€‚

# VPN Gateway ã®æ§‹æˆ

VPN ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ãã¾ã™ã€‚

ã€Œãƒã‚¤ãƒ³ãƒˆå¯¾ã‚µã‚¤ãƒˆã®æ§‹æˆã€ãƒ–ãƒ¬ãƒ¼ãƒ‰ã§ä»¥ä¸‹ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

-   **ãƒˆãƒ³ãƒãƒ«ã®ç¨®é¡ï¼šOpenVPN (SSL)**
-   **èªè¨¼ã®ç¨®é¡ï¼šAzure Active Directory (Entra ID)**

Azure Active Directory (Entra ID) ã®æƒ…å ±ã¯ã€[ã“ã¡ã‚‰](https://learn.microsoft.com/ja-jp/azure/vpn-gateway/point-to-site-entra-gateway#configure-vpn) ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ãƒ†ãƒŠãƒ³ãƒˆ ID ã‚’ä½¿ã£ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚

![alt text](/images/private-apim/create-vpngw-2.png)

è¨­å®šã‚’ä¿å­˜ã—ãŸã‚‰ã€ã€Œ**VPN ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ VPN ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™ã€‚

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸæ§‹æˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã™ã€‚ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ zip ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡ã—ã€`AzureVPN` ãƒ•ã‚©ãƒ«ãƒ€å†…ã« **"azurevpnconfig.xml"** ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

# VPN Gateway ã®æ¥ç¶š

> å‰æï¼šAzure VPN ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€[ã“ã¡ã‚‰](https://learn.microsoft.com/ja-jp/azure/vpn-gateway/point-to-site-entra-vpn-client-windows#download) ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

Azure VPN ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•ã—ã€å·¦ä¸‹ã®ã€Œ+ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚’é¸æŠã—ã¾ã™ã€‚

![alt text](/images/private-apim/connect-vpn-1.png)

å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ **"azurevpnconfig.xml"** ã‚’é–‹ãæ§‹æˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

ä»»æ„ã®æ¥ç¶šåã‚’å…¥åŠ›ã—ã€ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![alt text](/images/private-apim/connect-vpn-2.png)

æ¥ç¶šåã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ã€Œæ¥ç¶šã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¥ç¶šã‚’é–‹å§‹ã—ã¾ã™ã€‚

![alt text](/images/private-apim/connect-vpn-3.png)

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚„ã‚³ãƒãƒ³ãƒ‰ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æ¥ç¶šã‚’ç¢ºèªã—ã¾ã™ã€‚

```powershell
ipconfig
```

![alt text](/images/private-apim/check-vpn-connection.png)

# hosts ã®è¨­å®š

VPN Gateway ã«æ¥ç¶šã—ãŸã‚‰ã€Azure ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã® DNS åã‚’è§£æ±ºã§ãã‚‹ã‚ˆã†ã« hosts ã‚’è¨­å®šã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€æŒ‡å®šã—ãŸãƒªã‚½ãƒ¼ã‚¹ ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚ã‚‹ **ã™ã¹ã¦ã® Azure ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ DNS ã‚¾ãƒ¼ãƒ³å†…ã® A ãƒ¬ã‚³ãƒ¼ãƒ‰** ã‚’ä¸€è¦§è¡¨ç¤ºã—ã€è¦‹ã‚„ã™ãæ•´å½¢ã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ãŒã‚ã‚‹ãƒªã‚½ãƒ¼ã‚¹ ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

> ä»Šå›ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Microsoft çœŸå£ã•ã‚“ã®ã€Œ"Minimum Viable Sample" æ©Ÿèƒ½æœ€å°é™ãªç¤¾å†…æ–‡æ›¸ RAG ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ(ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¸›ã‚Š) ã€ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æµç”¨ã•ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚
>
> å‚è€ƒï¼š["Minimum Viable Sample" æ©Ÿèƒ½æœ€å°é™ãªç¤¾å†…æ–‡æ›¸ RAG ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ(ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¸›ã‚Š)](https://github.com/torumakabe/rag-chat-private-minimal/tree/main/scripts/util/hosts)

### PowerShell

```powershell
$ResourceGroup = "<RG_NAME>"

$zones = az network private-dns zone list --resource-group $ResourceGroup --query '[].name' -o tsv

foreach ($zone in $zones) {
    az network private-dns record-set a list --resource-group $ResourceGroup --zone-name $zone --query '[].{IP: aRecords[0].ipv4Address, FQDN: fqdn}' -o tsv |
    ForEach-Object { $_ -replace 'privatelink\.', '' -replace 'vaultcore', 'vault' -replace '\.$', '' }
}

# å‡ºåŠ›ä¾‹
10.0.1.4        private-apim-sample.azure-api.net
10.0.1.5        sample-private-api.azurewebsites.net
10.0.1.5        sample-private-api.scm.azurewebsites.net
```

### Bash

```bash
#!/usr/bin/env bash

set -o pipefail

if [ $# -eq 0 ]; then
  echo "Usage: $0 <resource_group>"
  exit 1
fi

zones=$(az network private-dns zone list --resource-group "$1" --query '[].name' -o tsv)

for zone in $zones; do
  az network private-dns record-set a list --resource-group "$1" --zone-name "$zone" --query '[].{IP: aRecords[0].ipv4Address, FQDN: fqdn}' -o tsv  | sed 's/privatelink\.//' | sed 's/vaultcore/vault/' | sed 's/\.$//'
done

# å‡ºåŠ›ä¾‹
10.0.1.4        private-apim-sample.azure-api.net
10.0.1.5        sample-private-api.azurewebsites.net
10.0.1.5        sample-private-api.scm.azurewebsites.net
```

å‡ºåŠ›ã•ã‚ŒãŸãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ãƒšã‚¢ã‚’ã‚³ãƒ”ãƒ¼ã—ã€`hosts` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã—ã¾ã™ã€‚

> Windows 11 ã®å ´åˆã€hosts ãƒ•ã‚¡ã‚¤ãƒ«ã¯ C:\Windows\System32\drivers\etc\hosts ã«ã‚ã‚Šã¾ã™ã€‚

# ã¾ã¨ã‚

ã“ã®è¨˜äº‹ã§ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ« PC ã‹ã‚‰ Azure ã®é–‰åŸŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

-   **VPN Gateway ã®ä½œæˆ**ã¨**ãƒã‚¤ãƒ³ãƒˆå¯¾ã‚µã‚¤ãƒˆæ¥ç¶šã®æ§‹æˆ**
-   Azure VPN ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ãŸãƒ­ãƒ¼ã‚«ãƒ« PC ã‹ã‚‰ã®æ¥ç¶šæ–¹æ³•
-   **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ DNS åã®åå‰è§£æ±º**ã«å¿…è¦ãª `hosts` ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´å‚™

ã“ã‚Œã‚‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€šã˜ã¦ã€**APIM ã‚„ Azure Functions ãªã©ã®é–‰åŸŸãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½**ã«ãªã‚Šã¾ã™ã€‚

ç‰¹ã«é–‹ç™ºãƒ»æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã®ç–é€šç¢ºèªãŒã§ãã‚‹ã“ã¨ã¯å¤§ããªãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚ä¸€æ–¹ã§ã€æœ¬ç•ªç’°å¢ƒã§ã¯ä¸è¦ãªã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ®‹ã•ãªã„ã‚ˆã†ã€VPN æ¥ç¶šã®ç®¡ç†ã«ã¯ååˆ†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
